# Story 4.2: 노트 내용 기반 자동 요약 생성

## Status
Ready for Review

## Story
**As a** 사용자,
**I want** 노트 내용을 기반으로 AI가 자동으로 요약을 생성하여,
**so that** 긴 노트의 핵심 내용을 빠르게 파악할 수 있다

## Acceptance Criteria
1. 노트 상세 페이지에서 "AI 요약 생성" 버튼이 표시됨
2. 버튼 클릭 시 Gemini API를 호출하여 3-6개 불릿 포인트로 요약 생성
3. 생성된 요약이 노트 상세 페이지에 표시됨
4. 요약 생성 중 로딩 상태가 표시됨
5. 요약 생성 실패 시 적절한 에러 메시지가 표시됨
6. 요약은 데이터베이스에 저장되어 재방문 시에도 표시됨

## Tasks / Subtasks
- [ ] Task 1: 데이터베이스 스키마 확장 (AC: 6)
  - [ ] Subtask 1.1: summaries 테이블 생성 마이그레이션 작성
  - [ ] Subtask 1.2: Drizzle 스키마에 summaries 테이블 정의 추가
  - [ ] Subtask 1.3: 마이그레이션 실행 및 스키마 동기화
- [ ] Task 2: 서버 액션 구현 (AC: 2, 5)
  - [ ] Subtask 2.1: lib/actions/notes.ts에 generateSummary 액션 추가
  - [ ] Subtask 2.2: GeminiClient.generateSummary 메서드 호출 로직 구현
  - [ ] Subtask 2.3: 요약 결과를 summaries 테이블에 저장하는 로직 구현
  - [ ] Subtask 2.4: 에러 핸들링 및 로깅 추가
- [ ] Task 3: UI 컴포넌트 구현 (AC: 1, 3, 4)
  - [ ] Subtask 3.1: components/notes/SummarySection.tsx 컴포넌트 생성
  - [ ] Subtask 3.2: "AI 요약 생성" 버튼 UI 구현
  - [ ] Subtask 3.3: 요약 내용 표시 UI 구현 (불릿 포인트 형태)
  - [ ] Subtask 3.4: 로딩 상태 표시 구현
  - [ ] Subtask 3.5: 에러 상태 표시 구현
- [ ] Task 4: 노트 상세 페이지 통합 (AC: 1, 3)
  - [ ] Subtask 4.1: app/notes/[id]/page.tsx에 SummarySection 컴포넌트 추가
  - [ ] Subtask 4.2: 기존 노트 데이터와 요약 데이터 조합 로직 구현
  - [ ] Subtask 4.3: 요약이 없는 경우와 있는 경우의 UI 분기 처리
- [ ] Task 5: 테스트 작성
  - [ ] Subtask 5.1: generateSummary 서버 액션 단위 테스트
  - [ ] Subtask 5.2: SummarySection 컴포넌트 테스트
  - [ ] Subtask 5.3: 통합 테스트 (노트 상세 페이지 + 요약 기능)
  - [ ] Subtask 5.4: 에러 시나리오 테스트

## Dev Notes

### Previous Story Insights
- Story 4.1에서 GeminiClient 클래스가 완전히 구현되어 있음
- generateSummary 메서드가 이미 구현되어 있어 바로 사용 가능
- 토큰 제한(8k), 재시도 로직, 에러 핸들링이 모두 구현됨
- 테스트 환경이 구축되어 있어 새로운 기능 테스트에 활용 가능

### Data Models
- **notes 테이블**: id, user_id, title, content, created_at, updated_at [Source: architecture.md#데이터-모델]
- **summaries 테이블**: note_id, model, content, created_at [Source: architecture.md#데이터-모델]
- **note_tags 테이블**: note_id, tag [Source: architecture.md#데이터-모델]

### API Specifications
- **GeminiClient.generateSummary()**: 이미 구현된 메서드 사용 [Source: Story 4.1 Dev Agent Record]
- **서버 액션**: lib/actions/notes.ts에 새로운 액션 추가 [Source: architecture.md#서버-액션]
- **토큰 제한**: 8k 토큰 제한 관리 필요 [Source: architecture.md#성능-가드레일]
- **서버사이드 호출**: 클라이언트에서 직접 외부 API 호출 금지, 서버사이드에서만 호출 [Source: 프로젝트 규칙]

### Component Specifications
- **SummarySection 컴포넌트**: 노트 상세 페이지에 통합될 독립적인 컴포넌트
- **UI 라이브러리**: shadcn/ui + Tailwind CSS 사용 [Source: architecture.md#기술-스택]
- **로딩 상태**: 사용자 경험을 위한 적절한 로딩 인디케이터 필요
- **에러 상태**: 사용자 친화적인 에러 메시지 표시

### File Locations
- **서버 액션**: lib/actions/notes.ts (수정)
- **UI 컴포넌트**: components/notes/SummarySection.tsx (새로 생성)
- **페이지 통합**: app/notes/[id]/page.tsx (수정)
- **데이터베이스**: drizzle/schema.ts (수정)
- **마이그레이션**: drizzle/migrations/ (새로 생성)
- **테스트 파일**: __tests__/notes/summary.test.tsx (새로 생성)

### Testing Requirements
- **테스트 위치**: __tests__/notes/ 디렉토리에 요약 관련 테스트 파일들
- **테스트 프레임워크**: Jest (기존 설정 사용)
- **단위 테스트**: generateSummary 서버 액션의 각 시나리오별 테스트
- **컴포넌트 테스트**: SummarySection 컴포넌트의 렌더링 및 상호작용 테스트
- **통합 테스트**: 노트 상세 페이지에서의 전체 요약 기능 테스트
- **에러 테스트**: API 실패, 네트워크 에러, 토큰 제한 초과 등 다양한 에러 시나리오

### Technical Constraints
- **토큰 제한**: 8k 토큰 제한 준수 [Source: architecture.md#성능-가드레일]
- **비동기 처리**: AI 처리 시간 10초 이내 목표 [Source: epic-4-ai-summarization-tagging.md#성공-지표]
- **보안**: API 키는 서버사이드에서만 사용, 클라이언트 노출 금지
- **에러 처리**: 재시도 로직과 적절한 에러 메시지 제공
- **성능**: 비동기 처리 및 로딩 상태 관리 필요
- **데이터베이스**: Drizzle ORM을 사용한 마이그레이션 및 쿼리 [Source: architecture.md#기술-스택]

## Testing
- **테스트 파일 위치**: __tests__/notes/summary.test.tsx
- **테스트 표준**: Jest 프레임워크 사용, 기존 테스트 패턴 준수
- **테스트 범위**:
  - generateSummary 서버 액션의 성공/실패 시나리오
  - SummarySection 컴포넌트의 렌더링 및 상호작용
  - 노트 상세 페이지에서의 통합 기능
  - 에러 핸들링 및 로딩 상태
- **모킹 전략**: GeminiClient는 모킹하여 테스트 안정성 확보

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Anthropic)

### Debug Log References
- Gemini API 연결 테스트: `app/api/test-gemini/route.ts`
- 요약 생성 로직: `lib/actions/notes.ts` (generateSummary, getNoteSummary)
- UI 컴포넌트: `components/notes/SummarySection.tsx`
- 데이터베이스 스키마: `drizzle/schema.ts` (summaries 테이블)

### Completion Notes List
- [x] 데이터베이스 스키마에 summaries 테이블 추가 및 마이그레이션 완료
- [x] generateSummary, getNoteSummary 서버 액션 구현 완료
- [x] SummarySection UI 컴포넌트 구현 완료 (로딩, 에러, 성공 상태 처리)
- [x] 노트 상세 페이지에 SummarySection 통합 완료 (반응형 레이아웃)
- [x] 포괄적인 테스트 작성 완료 (서버 액션, 컴포넌트 테스트)
- [x] Gemini API 연동 및 에러 처리 구현 완료
- [x] 토큰 제한 관리 및 재시도 로직 적용 완료

### File List
**새로 생성된 파일:**
- `components/notes/SummarySection.tsx` - AI 요약 섹션 UI 컴포넌트
- `__tests__/notes/summary.test.tsx` - 요약 기능 서버 액션 테스트
- `__tests__/components/SummarySection.test.tsx` - SummarySection 컴포넌트 테스트
- `components/ui/alert.tsx` - shadcn/ui Alert 컴포넌트

**수정된 파일:**
- `drizzle/schema.ts` - summaries 테이블 스키마 추가
- `lib/actions/notes.ts` - generateSummary, getNoteSummary 서버 액션 추가
- `app/notes/[id]/page.tsx` - SummarySection 컴포넌트 통합
- `jest.setup.js` - 테스트 환경 설정 개선 (TextEncoder, Web API polyfills)

**데이터베이스 변경:**
- `summaries` 테이블 생성 (id, note_id, model, content, created_at)
- 관련 인덱스 및 외래키 제약조건 추가

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 스토리 4.2 초기 구현 완료 | James (Dev) |

## QA Results
*QA 에이전트가 검토 후 채워집니다*
