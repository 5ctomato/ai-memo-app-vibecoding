# Story 4.1: Gemini API 설정 및 연동

## Status
Ready for Review

## Story
**As a** 개발자,
**I want** Google Gemini API를 프로젝트에 설정하고 연동하여,
**so that** AI 기반 요약 및 태깅 기능의 기반을 구축할 수 있다

## Acceptance Criteria
1. Google Gemini API 키가 환경변수로 안전하게 설정됨
2. Gemini API 클라이언트가 서버사이드에서 정상 동작함
3. API 호출 시 토큰 제한(8k 토큰) 관리가 구현됨
4. 에러 핸들링 및 재시도 로직이 포함됨
5. API 비용 모니터링을 위한 기본 로깅이 구현됨

## Tasks / Subtasks
- [x] Task 1: 패키지 의존성 설치 (AC: 1)
  - [x] Subtask 1.1: @google/genai 패키지 설치
  - [x] Subtask 1.2: 패키지 타입 정의 확인
- [x] Task 2: 환경 설정 및 API 키 관리 (AC: 1)
  - [x] Subtask 2.1: .env.local에 GEMINI_API_KEY 추가
  - [x] Subtask 2.2: lib/env.ts에 GEMINI_API_KEY 검증 로직 추가
  - [x] Subtask 2.3: 환경변수 타입 정의 추가
- [x] Task 3: Gemini API 클라이언트 구현 (AC: 2)
  - [x] Subtask 3.1: lib/ai/gemini.ts 파일 생성
  - [x] Subtask 3.2: Gemini API 클라이언트 클래스 구현
  - [x] Subtask 3.3: 기본 API 호출 메서드 구현
- [x] Task 4: 토큰 제한 관리 구현 (AC: 3)
  - [x] Subtask 4.1: 텍스트 토큰 카운팅 함수 구현 (tiktoken 또는 유사 라이브러리 사용)
  - [x] Subtask 4.2: 8k 토큰 제한 검증 로직 추가
  - [x] Subtask 4.3: 토큰 초과 시 에러 처리
- [x] Task 5: 에러 핸들링 및 재시도 로직 (AC: 4)
  - [x] Subtask 5.1: API 에러 타입 정의
  - [x] Subtask 5.2: 재시도 로직 구현 (최대 3회)
  - [x] Subtask 5.3: 타임아웃 처리 (10초)
- [x] Task 6: 로깅 및 모니터링 구현 (AC: 5)
  - [x] Subtask 6.1: API 호출 로깅 구현
  - [x] Subtask 6.2: 토큰 사용량 추적
  - [x] Subtask 6.3: 에러 로깅 구현
- [x] Task 7: 테스트 작성
  - [x] Subtask 7.1: Gemini API 클라이언트 단위 테스트
  - [x] Subtask 7.2: 토큰 제한 검증 테스트
  - [x] Subtask 7.3: 에러 핸들링 테스트
  - [x] Subtask 7.4: 통합 테스트 (실제 API 호출 제외)

## Dev Notes

### Previous Story Insights
- Epic 2에서 노트 관리 시스템이 완성되어 notes 테이블과 관련 서버 액션들이 구현됨
- 사용자 인증 시스템이 Supabase Auth로 구축되어 있음
- 서버 액션 패턴이 lib/actions/notes.ts에 구현되어 있음

### Data Models
- **notes 테이블**: id, user_id, title, content, created_at, updated_at [Source: architecture.md#데이터-모델]
- **summaries 테이블**: note_id, model, content, created_at [Source: architecture.md#데이터-모델]
- **note_tags 테이블**: note_id, tag [Source: architecture.md#데이터-모델]

### API Specifications
- **Gemini API**: Google Gemini API를 사용하여 요약 및 태깅 기능 구현 [Source: architecture.md#기술-스택]
- **API 패키지**: @google/genai 패키지 사용 (최신 버전)
- **모델**: gemini-1.5-flash 또는 gemini-1.5-pro 모델 사용
- **토큰 제한**: 8k 토큰 제한 관리 필요 [Source: architecture.md#성능-가드레일]
- **서버사이드 호출**: 클라이언트에서 직접 외부 API 호출 금지, 서버사이드에서만 호출 [Source: 프로젝트 규칙]
- **토큰 카운팅**: @google/genai 내장 토큰 카운터 사용
- **초기화**: GoogleGenAI 클래스 사용, 환경변수 GEMINI_API_KEY 자동 인식

### Component Specifications
- **서버 액션**: lib/actions/notes.ts에 AI 관련 액션 추가 예정
- **AI 클라이언트**: lib/ai/gemini.ts에 Gemini API 클라이언트 구현
- **환경 설정**: lib/env.ts에 API 키 검증 로직 추가

### Implementation Examples
```typescript
// lib/ai/gemini.ts 기본 구조
import { GoogleGenAI } from '@google/genai';

const ai = new GoogleGenAI({}); // GEMINI_API_KEY 환경변수 자동 인식

// 또는 명시적 설정
// const ai = new GoogleGenAI({apiKey: process.env.GEMINI_API_KEY});

// 모델 초기화
const model = ai.getGenerativeModel({ model: 'gemini-1.5-flash' });

// 기본 사용법
const result = await model.generateContent('Hello, Gemini!');
console.log(result.response.text());
```

### File Locations
- **AI 클라이언트**: lib/ai/gemini.ts (새로 생성)
- **환경 설정**: lib/env.ts (수정)
- **서버 액션**: lib/actions/notes.ts (수정)
- **테스트 파일**: __tests__/ai/gemini.test.ts (새로 생성)

### Testing Requirements
- **테스트 위치**: __tests__/ai/ 디렉토리에 AI 관련 테스트 파일들
- **테스트 프레임워크**: Jest (기존 설정 사용)
- **단위 테스트**: Gemini API 클라이언트의 각 메서드별 테스트
- **통합 테스트**: 실제 API 호출 없이 모킹을 통한 테스트
- **에러 테스트**: 네트워크 에러, API 에러, 토큰 제한 초과 등 다양한 에러 시나리오

### Technical Constraints
- **패키지 의존성**: @google/genai 패키지 설치 필요
- **토큰 제한**: 8k 토큰 제한 준수 [Source: architecture.md#성능-가드레일]
- **비동기 처리**: AI 처리 시간 10초 이내 목표 [Source: epic-4-ai-summarization-tagging.md#성공-지표]
- **보안**: API 키는 서버사이드에서만 사용, 클라이언트 노출 금지
- **에러 처리**: 재시도 로직과 적절한 에러 메시지 제공
- **성능**: 비동기 처리 및 로딩 상태 관리 필요
- **환경변수**: GEMINI_API_KEY를 .env.local에 추가하고 lib/env.ts에서 검증
- **초기화 방식**: `new GoogleGenAI({})` - 환경변수 자동 인식 또는 `new GoogleGenAI({apiKey: process.env.GEMINI_API_KEY})` 명시적 설정

## Testing
- **테스트 파일 위치**: __tests__/ai/gemini.test.ts
- **테스트 표준**: Jest 프레임워크 사용, 기존 테스트 패턴 준수
- **테스트 범위**: 
  - API 클라이언트 초기화 및 설정
  - 토큰 카운팅 및 제한 검증
  - 에러 핸들링 및 재시도 로직
  - 로깅 및 모니터링 기능
- **모킹 전략**: 실제 Gemini API 호출은 모킹하여 테스트 안정성 확보

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | Bob (SM) |
| 2024-12-19 | 1.1 | 패키지 의존성 및 기술 세부사항 추가 | Bob (SM) |
| 2024-12-19 | 1.2 | @google/genai 패키지로 수정 및 사용법 예시 추가 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Cursor AI Assistant)

### Debug Log References
- 패키지 설치: @google/genai 1.24.0 성공적으로 설치
- 환경변수 설정: GEMINI_API_KEY를 .env.local에 추가하고 lib/env.ts에서 검증 로직 구현
- API 클라이언트 구현: lib/ai/gemini.ts에 완전한 GeminiClient 클래스 구현
- 테스트 작성: 16개 테스트 모두 통과 (100% 성공률)

### Completion Notes List
- ✅ @google/genai 패키지 설치 완료
- ✅ 환경변수 GEMINI_API_KEY 설정 및 검증 로직 구현
- ✅ GeminiClient 클래스 구현 (토큰 제한, 재시도 로직, 에러 핸들링 포함)
- ✅ 노트 요약 및 태그 생성 메서드 구현
- ✅ 포괄적인 테스트 스위트 작성 및 모든 테스트 통과
- ✅ 로깅 및 모니터링 기능 구현
- ✅ 싱글톤 패턴으로 클라이언트 인스턴스 관리

### File List
- **새로 생성된 파일**:
  - `lib/ai/gemini.ts` - Gemini API 클라이언트 구현
  - `__tests__/ai/gemini.test.ts` - 포괄적인 테스트 스위트
- **수정된 파일**:
  - `.env.local` - GEMINI_API_KEY 환경변수 추가
  - `lib/env.ts` - GEMINI_API_KEY 검증 로직 추가
  - `package.json` - @google/genai 의존성 추가

## QA Results
*QA 에이전트가 검토 후 채워집니다*
