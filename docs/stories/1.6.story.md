# Story 1.6: 세션 상태 관리

## Status
Draft

## Story
**As a** 로그인된 사용자,
**I want** 앱 전체에서 일관된 인증 상태를 유지할 수 있도록,
**so that** 페이지 새로고침이나 브라우저 재시작 후에도 로그인 상태가 유지된다

## Acceptance Criteria
1. 앱 전체에서 사용자 인증 상태를 중앙 집중식으로 관리
2. 페이지 새로고침 시에도 로그인 상태 유지
3. 브라우저 탭 간 세션 상태 동기화
4. 세션 만료 시 자동 로그아웃 처리
5. 네트워크 연결 상태에 따른 세션 관리
6. 로그인/로그아웃 시 모든 컴포넌트에 즉시 반영
7. 세션 복원 중 로딩 상태 표시
8. 세션 에러 발생 시 적절한 에러 처리

## Tasks / Subtasks
- [ ] 중앙 집중식 세션 상태 관리 구현 (AC: 1, 6)
  - [ ] AuthContext를 통한 전역 상태 관리 강화
  - [ ] 세션 상태 변경 시 모든 컴포넌트 업데이트
  - [ ] 세션 상태 변경 이벤트 리스너 구현
- [ ] 세션 지속성 구현 (AC: 2, 3)
  - [ ] Supabase 세션 자동 복원 로직 구현
  - [ ] 브라우저 새로고침 시 세션 상태 복원
  - [ ] 탭 간 세션 상태 동기화 (localStorage 이벤트)
- [ ] 세션 만료 처리 (AC: 4)
  - [ ] 토큰 만료 시간 모니터링
  - [ ] 자동 토큰 갱신 로직 구현
  - [ ] 갱신 실패 시 자동 로그아웃
- [ ] 네트워크 상태 관리 (AC: 5)
  - [ ] 온라인/오프라인 상태 감지
  - [ ] 네트워크 복구 시 세션 상태 동기화
  - [ ] 오프라인 상태에서의 세션 유지
- [ ] 로딩 상태 및 에러 처리 (AC: 7, 8)
  - [ ] 세션 복원 중 로딩 스피너 표시
  - [ ] 세션 에러 발생 시 사용자 알림
  - [ ] 네트워크 에러 시 재시도 로직
- [ ] 기존 컴포넌트 통합 (AC: 6)
  - [ ] Header 컴포넌트 세션 상태 반영
  - [ ] 보호된 라우트 세션 검증
  - [ ] 모든 인증 관련 컴포넌트 업데이트
- [ ] 테스트 작성
  - [ ] 세션 상태 관리 테스트
  - [ ] 세션 복원 테스트
  - [ ] 세션 만료 처리 테스트
  - [ ] 네트워크 상태 테스트

## Dev Notes

### 기술 스택 정보
[Source: architecture.md#1]
- **프레임워크:** Next.js (App Router, Server Actions)
- **UI:** shadcn/ui + Tailwind + Radix UI
- **DB/인증:** Supabase (Postgres, Auth, Storage)
- **상태 관리:** React Context API + useState/useEffect

### 이전 스토리 인사이트
[Source: 1.1.story.md, 1.2.story.md, 1.3.story.md, 1.4.story.md, 1.5.story.md]
- useAuth 훅이 이미 구현되어 있음 (`lib/hooks/useAuth.ts`)
- AuthProvider가 이미 존재하고 기본 세션 관리 구현됨
- Supabase Auth의 onAuthStateChange 이벤트 활용 중
- 세션 복원을 위한 getSession() 호출 구현됨

### 기존 구현 상태
[Source: lib/hooks/useAuth.ts]
- `onAuthStateChange` 이벤트 리스너 구현됨
- `getSession()` 호출로 초기 세션 복원 구현됨
- 기본적인 로그인/로그아웃 상태 관리 구현됨

### 개선 필요 사항
- 세션 만료 시간 모니터링 및 자동 갱신
- 네트워크 상태 감지 및 처리
- 탭 간 세션 상태 동기화
- 더 강화된 에러 처리 및 로딩 상태

### Supabase Auth 세션 관리
[Source: Supabase Auth Documentation]
- `supabase.auth.getSession()` - 현재 세션 조회
- `supabase.auth.onAuthStateChange()` - 세션 상태 변경 감지
- `supabase.auth.refreshSession()` - 토큰 갱신
- `supabase.auth.signOut()` - 세션 종료

### 세션 만료 처리 전략
- Access Token 만료 시간: 1시간 (Supabase 기본값)
- Refresh Token 만료 시간: 30일 (Supabase 기본값)
- 토큰 만료 5분 전에 자동 갱신 시도
- 갱신 실패 시 자동 로그아웃 및 로그인 페이지 리다이렉트

### 네트워크 상태 관리
- `navigator.onLine` API 사용
- `online`/`offline` 이벤트 리스너 등록
- 오프라인 상태에서도 세션 정보 유지 (localStorage)
- 온라인 복구 시 Supabase와 세션 동기화

### 탭 간 동기화
- `storage` 이벤트 리스너로 localStorage 변경 감지
- 세션 상태 변경 시 다른 탭에 알림
- 중복 세션 복원 방지 로직

### 컴포넌트 업데이트 필요
- **AuthProvider**: 세션 관리 로직 강화
- **Header**: 세션 상태에 따른 UI 업데이트
- **보호된 라우트**: 세션 검증 강화
- **모든 인증 관련 컴포넌트**: 세션 상태 반영

### 파일 위치
[Source: architecture.md#1]
- **수정 파일**: `lib/hooks/useAuth.ts`, `components/providers/AuthProvider.tsx`
- **신규 파일**: `lib/hooks/useSession.ts`, `lib/utils/sessionManager.ts`
- **테스트**: `__tests__/hooks/useAuth.test.tsx`, `__tests__/hooks/useSession.test.tsx`

### 상태 관리 구조
```typescript
interface SessionState {
  user: User | null
  session: Session | null
  isLoading: boolean
  isOnline: boolean
  lastActivity: Date
  refreshTimer: NodeJS.Timeout | null
}
```

### 에러 처리 전략
- 네트워크 에러: 재시도 로직 + 사용자 알림
- 토큰 만료: 자동 갱신 시도 + 실패 시 로그아웃
- 세션 에러: 에러 로깅 + 사용자 알림
- 예상치 못한 에러: 폴백 로직 + 에러 리포팅

### 테스트 요구사항
[Source: Jest + React Testing Library]
- 세션 상태 관리 테스트
- 세션 복원 테스트 (새로고침 시뮬레이션)
- 세션 만료 처리 테스트
- 네트워크 상태 변화 테스트
- 탭 간 동기화 테스트
- Supabase Auth 함수 모킹

### 보안 고려사항
[Source: architecture.md#3]
- 세션 토큰은 httpOnly 쿠키 사용 고려
- 민감한 세션 정보는 메모리에만 저장
- 세션 만료 시 모든 토큰 완전 제거
- XSS 공격 방지를 위한 세션 데이터 검증

## Testing

### 테스트 파일 위치
- `__tests__/hooks/useAuth.test.tsx` (기존 테스트 확장)
- `__tests__/hooks/useSession.test.tsx` (신규)
- `__tests__/utils/sessionManager.test.ts` (신규)

### 테스트 표준
- Jest + React Testing Library 사용
- Supabase Auth 함수 모킹
- 네트워크 상태 모킹
- 탭 간 동기화 시뮬레이션

### 테스트 케이스
1. **세션 상태 관리 테스트**
   - 로그인/로그아웃 시 상태 업데이트
   - 모든 컴포넌트에 상태 반영
2. **세션 복원 테스트**
   - 페이지 새로고침 시 세션 복원
   - 브라우저 재시작 시 세션 복원
3. **세션 만료 처리 테스트**
   - 토큰 만료 시 자동 갱신
   - 갱신 실패 시 자동 로그아웃
4. **네트워크 상태 테스트**
   - 오프라인 상태에서 세션 유지
   - 온라인 복구 시 세션 동기화
5. **탭 간 동기화 테스트**
   - 한 탭에서 로그인/로그아웃 시 다른 탭 반영
   - 중복 세션 복원 방지

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-10-13 | 1.0 | 초기 스토리 생성 | Bob (SM) |

## Dev Agent Record
*이 섹션은 개발 에이전트가 구현 중에 채워집니다*

## QA Results
*이 섹션은 QA 에이전트가 검토 후 채워집니다*









