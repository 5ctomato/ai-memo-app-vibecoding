# Story 1.3: 비밀번호 재설정

## Status
Ready for Review

## Story
**As a** 등록된 사용자,
**I want** 비밀번호를 잊어버렸을 때 이메일을 통해 재설정할 수 있도록,
**so that** 계정에 다시 접근할 수 있다

## Acceptance Criteria
1. 비밀번호 재설정 요청 페이지 제공
2. 이메일 주소 입력 및 유효성 검사
3. 이메일로 재설정 링크 전송
4. 재설정 링크를 통한 새 비밀번호 설정
5. 재설정 링크의 유효성 검사 (만료 시간, 사용 여부)
6. 새 비밀번호 유효성 검사 (기존 비밀번호 규칙 적용)
7. 재설정 완료 후 로그인 페이지로 리다이렉트
8. 재설정 과정에서 발생하는 에러 메시지 한국어 표시

## Tasks / Subtasks
- [x] 비밀번호 재설정 요청 UI 구현 (AC: 1, 2)
  - [x] 이메일 입력 폼 컴포넌트 생성
  - [x] 이메일 유효성 검사 적용
  - [x] 요청 버튼 및 로딩 상태 처리
- [x] 이메일 전송 로직 구현 (AC: 3)
  - [x] Supabase Auth resetPasswordForEmail 함수 호출
  - [x] 이메일 전송 성공/실패 처리
  - [x] 에러 메시지 한국어 변환
- [x] 비밀번호 재설정 페이지 구현 (AC: 4, 5, 6)
  - [x] URL 파라미터에서 토큰 추출
  - [x] 토큰 유효성 검사
  - [x] 새 비밀번호 입력 폼
  - [x] 비밀번호 유효성 검사 (기존 규칙 재사용)
  - [x] 비밀번호 확인 입력
- [x] 재설정 완료 처리 (AC: 7)
  - [x] Supabase Auth updateUser 함수 호출
  - [x] 성공 시 로그인 페이지 리다이렉트
  - [x] 실패 시 에러 메시지 표시
- [x] 에러 핸들링 및 사용자 피드백 (AC: 8)
  - [x] 네트워크 에러 처리
  - [x] 토큰 만료/무효 에러 처리
  - [x] 기타 Supabase Auth 에러 처리
- [x] 테스트 작성
  - [x] 재설정 요청 폼 테스트
  - [x] 이메일 전송 로직 테스트
  - [x] 재설정 페이지 테스트
  - [x] 에러 케이스 테스트

## Dev Notes

### 기술 스택 정보
[Source: architecture.md#1]
- **프레임워크:** Next.js (App Router, Server Actions)
- **UI:** shadcn/ui + Tailwind + Radix UI
- **DB/인증:** Supabase (Postgres, Auth, Storage)
- **ORM:** Drizzle ORM (마이그레이션/쿼리)

### 이전 스토리 인사이트
[Source: 1.1.story.md, 1.2.story.md]
- 이메일 유효성 검사는 `lib/utils/validation.ts`의 `getEmailError` 함수 재사용
- 비밀번호 유효성 검사는 `lib/utils/validation.ts`의 `getPasswordError` 함수 재사용
- Supabase Auth 에러 메시지는 한국어로 변환하여 사용자에게 표시
- 폼 컴포넌트는 shadcn/ui 컴포넌트 사용 (Button, Input, Label, Card)

### API 명세
[Source: Supabase Auth Documentation]
- `supabase.auth.resetPasswordForEmail({ email, options })` - 비밀번호 재설정 이메일 전송
- `supabase.auth.updateUser({ password })` - 새 비밀번호로 업데이트
- 재설정 링크는 `{site_url}/auth/reset-password?token={access_token}` 형식

### 컴포넌트 명세
- **비밀번호 재설정 요청 페이지**: `/auth/forgot-password`
- **비밀번호 재설정 페이지**: `/auth/reset-password`
- 기존 UI 컴포넌트 재사용: Button, Input, Label, Card
- 에러 메시지는 빨간색 텍스트로 표시

### 파일 위치
[Source: architecture.md#1]
- **페이지**: `app/auth/forgot-password/page.tsx`, `app/auth/reset-password/page.tsx`
- **컴포넌트**: `components/auth/ForgotPasswordForm.tsx`, `components/auth/ResetPasswordForm.tsx`
- **유틸리티**: `lib/utils/validation.ts` (기존 함수 재사용)
- **테스트**: `__tests__/auth/forgot-password.test.tsx`, `__tests__/auth/reset-password.test.tsx`

### 테스트 요구사항
- Jest + React Testing Library 사용
- Supabase Auth 함수 모킹
- 이메일 유효성 검사 테스트
- 비밀번호 유효성 검사 테스트
- 에러 케이스 테스트 (네트워크, 토큰 만료 등)
- 성공 시나리오 테스트

### 보안 고려사항
[Source: architecture.md#3]
- 재설정 토큰은 일회성 사용
- 토큰 만료 시간 준수
- 새 비밀번호는 기존 비밀번호 규칙 적용

## Testing

### 테스트 파일 위치
- `__tests__/auth/forgot-password.test.tsx`
- `__tests__/auth/reset-password.test.tsx`

### 테스트 표준
- Jest + React Testing Library 사용
- Supabase Auth 함수 모킹
- 사용자 상호작용 시뮬레이션 (fireEvent)
- 비동기 작업 처리 (waitFor)

### 테스트 케이스
1. **재설정 요청 폼 테스트**
   - 폼 렌더링 확인
   - 이메일 유효성 검사
   - 제출 시 Supabase 함수 호출 확인
2. **재설정 페이지 테스트**
   - 토큰 유효성 검사
   - 비밀번호 유효성 검사
   - 재설정 완료 후 리다이렉트
3. **에러 케이스 테스트**
   - 네트워크 에러
   - 토큰 만료
   - 잘못된 토큰

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-10-13 | 1.0 | 초기 스토리 생성 | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- Radix UI Dialog 컴포넌트 추가
- 비밀번호 재설정 플로우 완전 구현
- 토큰 유효성 검사 및 에러 처리

### Completion Notes List
- 모든 Acceptance Criteria 충족
- 13개 테스트 모두 통과 (비밀번호 재설정 요청 6개, 비밀번호 재설정 7개)
- 이메일 기반 비밀번호 재설정 플로우 완전 구현
- 토큰 유효성 검사 및 만료 처리
- 한국어 에러 메시지 변환
- 기존 유효성 검사 함수 재사용

### File List
**생성된 파일:**
- `app/auth/forgot-password/page.tsx` - 비밀번호 재설정 요청 페이지
- `app/auth/reset-password/page.tsx` - 비밀번호 재설정 페이지
- `components/auth/ForgotPasswordForm.tsx` - 비밀번호 재설정 요청 폼
- `components/auth/ResetPasswordForm.tsx` - 비밀번호 재설정 폼
- `components/ui/dialog.tsx` - Dialog UI 컴포넌트
- `__tests__/auth/forgot-password.test.tsx` - 비밀번호 재설정 요청 테스트
- `__tests__/auth/reset-password.test.tsx` - 비밀번호 재설정 테스트

**수정된 파일:**
- `components/auth/LoginForm.tsx` - 비밀번호 재설정 링크 추가
- `package.json` - @radix-ui/react-dialog, lucide-react 의존성 추가

## QA Results
*이 섹션은 QA 에이전트가 검토 후 채워집니다*
