# Story 1.7: 인증 에러 핸들링

## Status
Draft

## Story
**As a** 사용자,
**I want** 인증 과정에서 발생하는 모든 에러를 명확하고 도움이 되는 메시지로 확인할 수 있도록,
**so that** 문제를 해결하고 앱을 계속 사용할 수 있다

## Acceptance Criteria
1. 모든 인증 에러를 한국어로 번역하여 표시
2. 네트워크 에러와 인증 에러를 구분하여 처리
3. 에러 발생 시 사용자에게 구체적인 해결 방법 제시
4. 일시적 에러의 경우 자동 재시도 옵션 제공
5. 심각한 에러의 경우 고객 지원 연락처 안내
6. 에러 로깅 및 모니터링 시스템 연동
7. 에러 발생 시 사용자 경험을 최소한으로 방해
8. 에러 상태에서도 앱의 기본 기능은 유지

## Tasks / Subtasks
- [ ] 에러 분류 및 메시지 시스템 구현 (AC: 1, 2)
  - [ ] Supabase Auth 에러 코드별 한국어 메시지 매핑
  - [ ] 네트워크 에러와 인증 에러 분류 로직
  - [ ] 에러 메시지 중앙 집중식 관리
- [ ] 사용자 친화적 에러 UI 구현 (AC: 3, 7)
  - [ ] 에러 토스트/알림 컴포넌트 생성
  - [ ] 에러 상세 정보 표시 모달
  - [ ] 에러 발생 시 폼 상태 유지
- [ ] 자동 재시도 및 복구 로직 (AC: 4, 8)
  - [ ] 일시적 네트워크 에러 자동 재시도
  - [ ] 재시도 횟수 제한 및 백오프 전략
  - [ ] 에러 발생 시 폴백 동작 구현
- [ ] 고객 지원 연동 (AC: 5)
  - [ ] 심각한 에러 시 지원 연락처 표시
  - [ ] 에러 리포트 생성 및 전송 기능
  - [ ] 에러 컨텍스트 정보 수집
- [ ] 에러 로깅 및 모니터링 (AC: 6)
  - [ ] 에러 발생 시 로그 기록
  - [ ] 에러 통계 수집 (개인정보 제외)
  - [ ] 개발자용 에러 디버깅 정보
- [ ] 기존 컴포넌트 에러 처리 강화 (AC: 1, 2)
  - [ ] SignupForm 에러 처리 개선
  - [ ] LoginForm 에러 처리 개선
  - [ ] ForgotPasswordForm 에러 처리 개선
  - [ ] ResetPasswordForm 에러 처리 개선
- [ ] 테스트 작성
  - [ ] 에러 메시지 표시 테스트
  - [ ] 자동 재시도 로직 테스트
  - [ ] 에러 로깅 테스트
  - [ ] 사용자 경험 테스트

## Dev Notes

### 기술 스택 정보
[Source: architecture.md#1]
- **프레임워크:** Next.js (App Router, Server Actions)
- **UI:** shadcn/ui + Tailwind + Radix UI
- **DB/인증:** Supabase (Postgres, Auth, Storage)
- **에러 모니터링:** 선택적 Sentry 연동

### 이전 스토리 인사이트
[Source: 1.1.story.md, 1.2.story.md, 1.3.story.md, 1.4.story.md]
- 각 인증 컴포넌트에 기본적인 에러 처리 구현됨
- Supabase Auth 에러 메시지 한국어 변환 로직 존재
- 에러 상태 관리를 위한 useState 패턴 사용
- shadcn/ui 컴포넌트를 활용한 에러 UI 구현

### 기존 에러 처리 상태
[Source: components/auth/*.tsx]
- SignupForm: 기본적인 Supabase 에러 메시지 변환
- LoginForm: 네트워크 에러 및 인증 에러 처리
- ForgotPasswordForm: 보안 제한 메시지 동적 변환
- ResetPasswordForm: 토큰 유효성 에러 처리

### 개선 필요 사항
- 에러 메시지 중앙 집중식 관리
- 일관된 에러 UI/UX 패턴
- 자동 재시도 및 복구 로직
- 에러 로깅 및 모니터링
- 사용자 지원 연동

### Supabase Auth 에러 분류
[Source: Supabase Auth Documentation]
1. **네트워크 에러**: 연결 실패, 타임아웃
2. **인증 에러**: 잘못된 자격증명, 계정 비활성화
3. **권한 에러**: 접근 권한 없음, 세션 만료
4. **서버 에러**: Supabase 서비스 장애
5. **클라이언트 에러**: 잘못된 요청, 유효성 검사 실패

### 에러 메시지 매핑 전략
```typescript
const ERROR_MESSAGES = {
  // 네트워크 에러
  'Network error': '네트워크 연결을 확인해주세요.',
  'Failed to fetch': '서버에 연결할 수 없습니다.',
  
  // 인증 에러
  'Invalid login credentials': '잘못된 이메일 또는 비밀번호입니다.',
  'Email not confirmed': '이메일 인증이 필요합니다.',
  'User not found': '등록되지 않은 이메일 주소입니다.',
  
  // 권한 에러
  'Invalid session': '세션이 만료되었습니다.',
  'Access denied': '접근 권한이 없습니다.',
  
  // 서버 에러
  'Internal server error': '서버 오류가 발생했습니다.',
  'Service unavailable': '서비스가 일시적으로 사용할 수 없습니다.',
}
```

### 자동 재시도 전략
- **네트워크 에러**: 3회 재시도, 지수 백오프 (1초, 2초, 4초)
- **일시적 서버 에러**: 2회 재시도, 선형 백오프 (2초, 4초)
- **인증 에러**: 재시도 없음 (사용자 입력 필요)
- **권한 에러**: 재시도 없음 (로그인 필요)

### 에러 UI 컴포넌트
- **Toast 알림**: 일시적 에러 메시지
- **인라인 에러**: 폼 필드별 에러 메시지
- **에러 모달**: 심각한 에러 상세 정보
- **에러 페이지**: 복구 불가능한 에러

### 에러 로깅 구조
```typescript
interface ErrorLog {
  timestamp: Date
  userId?: string
  errorType: 'network' | 'auth' | 'permission' | 'server' | 'client'
  errorCode: string
  errorMessage: string
  userAgent: string
  url: string
  stackTrace?: string
}
```

### 고객 지원 연동
- 심각한 에러 시 "문의하기" 버튼 표시
- 에러 컨텍스트 정보 자동 수집
- 지원팀용 에러 리포트 생성
- 사용자 식별 정보 제외한 로그 전송

### 파일 위치
[Source: architecture.md#1]
- **에러 유틸리티**: `lib/utils/errorHandler.ts`
- **에러 컴포넌트**: `components/ui/ErrorToast.tsx`, `components/ui/ErrorModal.tsx`
- **에러 훅**: `lib/hooks/useErrorHandler.ts`
- **테스트**: `__tests__/utils/errorHandler.test.ts`, `__tests__/hooks/useErrorHandler.test.tsx`

### 기존 컴포넌트 수정
- **SignupForm**: 에러 처리 로직 중앙화
- **LoginForm**: 자동 재시도 로직 추가
- **ForgotPasswordForm**: 에러 분류 개선
- **ResetPasswordForm**: 복구 로직 강화

### 테스트 요구사항
[Source: Jest + React Testing Library]
- 에러 메시지 표시 테스트
- 자동 재시도 로직 테스트
- 에러 로깅 테스트
- 사용자 상호작용 테스트
- 네트워크 상태 모킹

### 보안 고건사항
[Source: architecture.md#3]
- 에러 로그에 민감한 정보 포함 금지
- 사용자 식별 정보는 해시화하여 저장
- 에러 리포트는 암호화하여 전송
- 클라이언트 에러는 서버 검증 필수

## Testing

### 테스트 파일 위치
- `__tests__/utils/errorHandler.test.ts`
- `__tests__/hooks/useErrorHandler.test.tsx`
- `__tests__/components/ui/ErrorToast.test.tsx`
- `__tests__/components/ui/ErrorModal.test.tsx`

### 테스트 표준
- Jest + React Testing Library 사용
- 네트워크 상태 모킹
- 에러 시나리오 시뮬레이션
- 사용자 상호작용 테스트

### 테스트 케이스
1. **에러 메시지 표시 테스트**
   - 각 에러 타입별 메시지 표시
   - 한국어 번역 정확성
2. **자동 재시도 테스트**
   - 네트워크 에러 시 재시도 로직
   - 재시도 횟수 제한
3. **에러 로깅 테스트**
   - 에러 발생 시 로그 기록
   - 민감한 정보 제외 확인
4. **사용자 경험 테스트**
   - 에러 발생 시 폼 상태 유지
   - 복구 옵션 제공
   - 고객 지원 연동

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-10-13 | 1.0 | 초기 스토리 생성 | Bob (SM) |

## Dev Agent Record
*이 섹션은 개발 에이전트가 구현 중에 채워집니다*

## QA Results
*이 섹션은 QA 에이전트가 검토 후 채워집니다*










